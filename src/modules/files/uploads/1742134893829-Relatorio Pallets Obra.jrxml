<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="Relatorio Pallets Obra" language="groovy" pageWidth="595" pageHeight="842" columnWidth="525" leftMargin="28" rightMargin="42" topMargin="28" bottomMargin="21">
	<property name="ireport.zoom" value="2.0"/>
	<property name="ireport.x" value="5"/>
	<property name="ireport.y" value="0"/>
	<property name="ireport.definition"/>
	<parameter name="CODEMP" class="java.lang.String">
		<property name="PESQUISA" value="TRUE"/>
		<property name="NOMETABELA" value="TGFEMP"/>
		<parameterDescription><![CDATA[Código Empresa]]></parameterDescription>
		<defaultValueExpression><![CDATA[null]]></defaultValueExpression>
	</parameter>
	<parameter name="DATAINI" class="java.sql.Timestamp">
		<parameterDescription><![CDATA[Data Inicial]]></parameterDescription>
	</parameter>
	<parameter name="DATAFIM" class="java.sql.Timestamp">
		<parameterDescription><![CDATA[Data Fim]]></parameterDescription>
	</parameter>
	<parameter name="NOME_REL" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["Relatório Pallets por Obra"]]></defaultValueExpression>
	</parameter>
	<parameter name="CORPARC" class="java.lang.String">
		<property name="pesquisa" value="true"/>
		<property name="nometabela" value="TGFPAR"/>
		<parameterDescription><![CDATA[Código Parceiro]]></parameterDescription>
		<defaultValueExpression><![CDATA[null]]></defaultValueExpression>
	</parameter>
	<parameter name="CODVEND" class="java.lang.String">
		<property name="pesquisa" value="true"/>
		<property name="nometabela" value="TGFVEN"/>
		<parameterDescription><![CDATA[Código Vendedor]]></parameterDescription>
		<defaultValueExpression><![CDATA[null]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT
PARCEIRO,
CODPARC,
CODVEND,
APELIDO,
COALESCE(OBRA, '') AS OBRA,
PRODUTO,
DESCR,
UNIDADE,
SUM(ENVIADO) AS ENVIADO,
SUM(DEVOLVIDO) AS DEVOLVIDO,
SUM(SALDO) AS SALDO
FROM (SELECT
    CAB.CODPARC,
    PAR.NOMEPARC AS PARCEIRO,

    COALESCE(
        (SELECT AD_NOMEOBRA
        FROM TGFCAB
        INNER JOIN TGFPAR ON TGFPAR.CODPARC = TGFCAB.CODPARC
        INNER JOIN TGFCTT CTT ON CTT.CODCONTATO = TGFCAB.CODCONTATOENTREGA AND CTT.CODPARC = TGFCAB.CODPARC
        WHERE TGFCAB.NUNOTA = CAB.AD_NUNOTAORIG
        ), ''
    ) AS OBRA,
	COALESCE(
        (SELECT CODVEND
        FROM TGFCAB CAB2
        WHERE CAB2.NUNOTA = CAB.AD_NUNOTAORIG
        ), CAB.CODVEND
    ) AS CODVEND,
	COALESCE(
        (SELECT VEN.APELIDO
        FROM TGFCAB CAB3
		INNER JOIN TGFVEN VEN ON CAB3.CODVEND = VEN.CODVEND
        WHERE CAB3.NUNOTA = CAB.AD_NUNOTAORIG
        ), (SELECT NVL(APELIDO,'') FROM TGFVEN WHERE CODVEND = CAB.CODVEND)
    ) AS APELIDO,

    ITE.CODPROD AS PRODUTO,
    PAR.NOMEPARC,
    PRO.DESCRPROD AS DESCR,
    ITE.CODVOL AS UNIDADE,
    (ITE.QTDNEG) AS ENVIADO,
    (ITE.QTDENTREGUE) AS DEVOLVIDO,
    (ITE.QTDNEG - ITE.QTDENTREGUE) AS SALDO


 FROM
    TGFCAB CAB
    INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA,
    TGFTOP TOP,
    TGFPRO PRO,
    TGFPAR PAR

 WHERE
		CAB.CODTIPOPER = TOP.CODTIPOPER AND
		CAB.DHTIPOPER = TOP.DHALTER AND
		ITE.CODPROD = PRO.CODPROD AND
		CAB.CODPARC = PAR.CODPARC AND
		TOP.ATUALESTTERC = 'P' AND
  		CAB.DTENTSAI >= $P{DATAINI} AND
		CAB.DTENTSAI <= $P{DATAFIM} AND
		(CAB.CODEMP = $P{CODEMP}   OR $P{CODEMP} IS NULL) AND
		TOP.CODTIPOPER NOT IN  (5260,2105,5299) AND
		(CAB.CODPARC = $P{CORPARC} OR $P{CORPARC} IS NULL )

) TB

WHERE (TB.CODVEND = $P{CODVEND} OR $P{CODVEND} IS NULL)

AND SALDO > 0

GROUP BY
PARCEIRO,
CODPARC,
CODVEND,
APELIDO,
OBRA,
PRODUTO,
DESCR,
UNIDADE

ORDER BY
PARCEIRO]]>
	</queryString>
	<field name="PRODUTO" class="java.lang.String"/>
	<field name="DESCR" class="java.lang.String"/>
	<field name="PARCEIRO" class="java.lang.String"/>
	<field name="OBRA" class="java.lang.String"/>
	<field name="UNIDADE" class="java.lang.String"/>
	<field name="ENVIADO" class="java.math.BigDecimal"/>
	<field name="DEVOLVIDO" class="java.math.BigDecimal"/>
	<field name="SALDO" class="java.math.BigDecimal"/>
	<field name="CODPARC" class="java.lang.String"/>
	<field name="CODVEND" class="java.lang.String"/>
	<field name="APELIDO" class="java.lang.String"/>
	<variable name="SUM_ENVIADO" class="java.math.BigDecimal" resetType="Group" resetGroup="group_1" calculation="Sum">
		<variableExpression><![CDATA[$F{ENVIADO}]]></variableExpression>
		<initialValueExpression><![CDATA[new BigDecimal(0)]]></initialValueExpression>
	</variable>
	<variable name="SUM_DEVOLVIDO" class="java.math.BigDecimal" resetType="Group" resetGroup="group_1" calculation="Sum">
		<variableExpression><![CDATA[$F{DEVOLVIDO}]]></variableExpression>
		<initialValueExpression><![CDATA[new BigDecimal(0)]]></initialValueExpression>
	</variable>
	<variable name="SUM_SALDO" class="java.math.BigDecimal" resetType="Group" resetGroup="group_1" calculation="Sum">
		<variableExpression><![CDATA[$F{SALDO}]]></variableExpression>
		<initialValueExpression><![CDATA[new BigDecimal(0)]]></initialValueExpression>
	</variable>
	<group name="group_1">
		<groupExpression><![CDATA[$F{PARCEIRO}]]></groupExpression>
		<groupHeader>
			<band height="16">
				<rectangle>
					<reportElement x="0" y="0" width="525" height="16" backcolor="#CCCCCC"/>
					<graphicElement>
						<pen lineWidth="0.0"/>
					</graphicElement>
				</rectangle>
				<textField>
					<reportElement x="8" y="2" width="46" height="11"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA["Parceiro:"]]></textFieldExpression>
				</textField>
				<textField>
					<reportElement x="47" y="2" width="475" height="11"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{CODPARC}+ " - " + $F{PARCEIRO}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="19">
				<line>
					<reportElement x="374" y="4" width="149" height="1"/>
				</line>
				<textField pattern="#,##0.00">
					<reportElement x="375" y="6" width="49" height="11"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{SUM_ENVIADO}]]></textFieldExpression>
				</textField>
				<textField pattern="#,##0.00">
					<reportElement x="426" y="6" width="46" height="11"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{SUM_DEVOLVIDO}]]></textFieldExpression>
				</textField>
				<textField pattern="#,##0.00">
					<reportElement x="473" y="6" width="49" height="11"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{SUM_SALDO}]]></textFieldExpression>
				</textField>
			</band>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="79" splitType="Stretch"/>
	</title>
	<pageHeader>
		<band height="37" splitType="Stretch">
			<textField pattern="" isBlankWhenNull="false">
				<reportElement mode="Opaque" x="6" y="20" width="349" height="14" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Left" verticalAlignment="Middle" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="12" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Courier-Bold" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{NOME_REL}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="354" y="22" width="169" height="12"/>
				<textElement textAlignment="Right">
					<font fontName="Courier New" size="10" pdfFontName="br/com/sankhya/modelcore/report/font/cour.ttf" isPdfEmbedded="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[br.com.sankhya.modelcore.report.CustomReportUtils.str(" Emissão " + new java.text.SimpleDateFormat("dd/MM/yyyy HH:mm:ss").format(new java.util.Date()))]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField-6" mode="Opaque" x="6" y="0" width="325" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#FFFFFF"/>
				</box>
				<textElement textAlignment="Left" verticalAlignment="Middle" rotation="None" lineSpacing="Single">
					<font fontName="Arial" size="14" isBold="true" isItalic="true" isUnderline="false" isStrikeThrough="false" pdfFontName="Times-BoldItalic" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[br.com.sankhya.modelcore.profile.ApplicationProfileManager.getInstance().isJivaW() ? "JivaW - Comercial" : "SankhyaW - Comercial"]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" pattern="" isBlankWhenNull="false">
				<reportElement key="textField-5" mode="Opaque" x="475" y="6" width="48" height="12" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#FFFFFF"/>
				</box>
				<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
					<font fontName="Courier New" size="10" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Courier" pdfEncoding="Cp1252" isPdfEmbedded="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[""+$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField-1" mode="Opaque" x="365" y="6" width="108" height="12" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#FFFFFF"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single">
					<font fontName="Courier New" size="10" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Courier" pdfEncoding="Cp1252" isPdfEmbedded="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Página " + $V{PAGE_NUMBER} + " de "]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="15" splitType="Stretch">
			<textField>
				<reportElement x="7" y="2" width="30" height="13"/>
				<textElement textAlignment="Right">
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Cod."]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="41" y="2" width="224" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Descrição Produto"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="265" y="2" width="74" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Obra"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="339" y="2" width="29" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["UN"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="368" y="2" width="50" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Enviado"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="418" y="2" width="50" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Devolvido"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="468" y="2" width="48" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Saldo"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="168" y="2" width="97" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Vendedor"]]></textFieldExpression>
			</textField>
		</band>
	</columnHeader>
	<detail>
		<band height="16" splitType="Stretch">
			<textField>
				<reportElement x="3" y="2" width="42" height="12"/>
				<textElement textAlignment="Right">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{PRODUTO}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="47" y="2" width="121" height="12"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{DESCR}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="345" y="2" width="29" height="12"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{UNIDADE}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00">
				<reportElement x="374" y="2" width="50" height="12"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{ENVIADO}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00">
				<reportElement x="424" y="2" width="48" height="12"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{DEVOLVIDO}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00">
				<reportElement x="472" y="2" width="50" height="12"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{SALDO}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="273" y="2" width="72" height="12"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{OBRA}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="168" y="2" width="105" height="12"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{CODVEND} + " - " + $F{APELIDO}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<pageFooter>
		<band height="13" splitType="Stretch"/>
	</pageFooter>
	<summary>
		<band height="6" splitType="Stretch">
			<line>
				<reportElement x="0" y="5" width="525" height="1"/>
			</line>
		</band>
	</summary>
</jasperReport>
